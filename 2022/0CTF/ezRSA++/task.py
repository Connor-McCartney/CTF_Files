from Crypto.Util.number import *
from os import urandom
from secret import flag

def ExGCD(a, b):
    if 0 == b:
        return 1, 0, a
    x, y, q = ExGCD(b, a % b)
    x, y = y, (x - a // b * y)
    return x, y, q

def gen(p_size, d_size, l_size):
    while True:
        p = getPrime(p_size)
        q = getPrime(p_size)
        if GCD(p - 1, q - 1) == 2:
            break
    d_p = getPrime(d_size)
    d_q = getPrime(d_size)
    s, t, g = ExGCD(p - 1, q - 1)
    if s < 0:
        s += q - 1
    else:
        t += p - 1
    n = p * q
    phi = (p - 1) * (q - 1)
    e = (inverse(d_p, p - 1) * t * (q - 1) + inverse(d_q, q - 1)  * s * (p - 1)) // g % phi
    assert (e * d_q % (q - 1) == 1)
    assert (e * d_p % (p - 1) == 1)
    k = (e * d_p - 1) // (p - 1)
    l = (e * d_q - 1) // (q - 1)
    return (n, e), (d_p, d_q, p, q), (d_p % (2**l_size), d_q % (2**l_size))
    
def encrypt(m, pk):
    n, e = pk
    return pow(m, e, n)

p_size = 1000
d_size = 105
l_size = 55
pk, sk, hint = gen(p_size, d_size, l_size)
flag = urandom(2 * p_size // 8 - len(flag) - 1) + flag
enc = encrypt(int(flag.hex(), 16), pk)
print(enc)
print(pk)
print(hint)

'''
35558284230663313298312684064040643811204702946900174110911295087662938676356112802781671547473910691476600838877279843972105403072929243674403244286458898562457747942651643439624568905004454158744508429126554955023110569348839934098381885098523538078300248638407684468503519326866276798222721018258242443186786917829878515320321445508466038372324063139762003962072922393974710763356236627711414307859950011736526834586028087922704589199885845050751932885698053938070734392371814246294798366452078193195538346218718588887085179856336533576097324041969786125752304133487678308830354729347735644474025828
(44774502335951608354043148360684114092901940301155357314508676399067538307546121753785009844275454594381602690061553832466871574728524408152400619047820736137949166290404514747591817206669966103047443912935755873432503095952914080827536130899968275165557303493867755627520568588808534411526058896791373252974606364861105086430729757064078675811147972536205086402752245214343186536177015741922559575575911278873118556603923689408629477875537332177644886701517140711134017511229202430437068095342526435886609381176269251580339549071944830141516001532825295594908434587285225415103472279090325281062442217, 29624366183227462965645558392954094074485353876807451497147549927093025197118051280445930543762170853769573962200247669305286333212410439624262142109295839433584663989554419810341266820063074908743295553517790354149623873028162282751352613333181218478850463012413786673509078012976454604598813805735677104174112776060905225493357010861225261560490401501912259585922988353328944884443953564154752191932500561561256069872534626325000901099904014035414792860997025614313564862063784602254606240743545483125618939111639728114664995759380293512809125885893543730614962375399353971677980309835647540883700977)
(5013415024346389, 4333469053087705)
'''